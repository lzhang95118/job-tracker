<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>Edit Job</title>
  <link rel="stylesheet" href="style.css">
</head>
<body style="padding:20px;max-width:500px;">
  <h3>Edit Job</h3>

  <form id="editForm">
    <input type="hidden" name="id">

    <label>Status:
      <input name="status" required>
    </label><br><br>

    <label>Apply&nbsp;Date:
      <input type="date" name="apply_date">
    </label><br><br>

    <label>Interview&nbsp;Date:
      <input type="date" name="interview_date">
    </label><br><br>

    <label>Notes:
      <textarea name="notes" rows="3"></textarea>
    </label><br><br>

    <button>Save</button>
    <button type="button" onclick="window.close()">Cancel</button>
  </form>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://noyxgznbnarahetfecxj.supabase.co",
      "YOUR_PUBLIC_SUPABASE_KEY"
    );

    const id = new URLSearchParams(location.search).get("id");
    if(!id){ alert("No id"); window.close(); }

    const { data, error } = await supabase
      .from("general_application")
      .select("*").eq("id", id).single();

    if(error){ alert(error.message); window.close(); }

    for(const [k,v] of Object.entries(data)){
      const el = document.querySelector(`[name=${k}]`);
      if(el) el.value = v ?? "";
    }

    document.getElementById("editForm").addEventListener("submit", async e=>{
      e.preventDefault();
      const f = Object.fromEntries(new FormData(e.target));
      const { error } = await supabase
        .from("general_application")
        .update({
          status:         f.status,
          apply_date:     f.apply_date     || null,
          interview_date: f.interview_date || null,
          notes:          f.notes          || null
        })
        .eq("id", id);

      if(error){ alert(error.message); return; }

      localStorage.setItem("jobUpdated", Date.now());
      window.close();
    });
  </script>
</body>
</html>
