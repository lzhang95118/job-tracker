<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Job Tracker</title>

  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/htmx.org@1.9.2"></script>

  <script type="module" defer>
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    /* ---------- Supabase ---------- */
    const supabase = createClient(
      "https://noyxgznbnarahetfecxj.supabase.co",
      "YOUR_PUBLIC_SUPABASE_KEY"
    );

    /* ---------- å…¨å±€ç¼“å­˜ ---------- */
    let cache = [];

    /* ---------- ä¸»å…¥å£ ---------- */
    document.addEventListener("DOMContentLoaded", () => {
      loadJobs();

      /* åˆ—è¡¨ç¼–è¾‘å®Œ -> æœ¬é¡µè·å¾—ç„¦ç‚¹ or storage äº‹ä»¶ -> reload */
      window.addEventListener("focus", maybeReloadAfterEdit);
      window.addEventListener("storage", e => {
        if (e.key === "jobUpdated") loadJobs();
      });
    });

    /* ---------- æ•°æ®æŸ¥è¯¢ & æ¸²æŸ“ ---------- */
    async function loadJobs(){
      const { data, error } = await supabase
        .from("general_application")            // â† ç›´æ¥æŸ¥è¡¨
        .select("*")
        .order("deadline", {ascending: true});
      renderTable(data, error);
    }
    window.loadJobs = loadJobs;   // æš´éœ²ç»™å­çª—å£ï¼ˆå¯é€‰ï¼‰

    function renderTable(data=[], error=null, keyword=''){
      cache = data || [];
      const box = document.getElementById("job-table");

      if(error){ box.textContent = "Error: " + error.message; return; }
      if(!Array.isArray(data) || !data.length){ box.textContent = "No data."; return; }

      const q = keyword.trim().toLowerCase();
      const rows = q
        ? data.filter(j =>
            (j.job_title||'').toLowerCase().includes(q) ||
            (j.company||'').toLowerCase().includes(q)   ||
            (j.vacancy_code||'').toLowerCase().includes(q))
        : data;

      const tbl = document.createElement("table");
      const head = tbl.insertRow();
      ["Company","Job Title","Deadline","Interview",
       "Status","ApplyÂ Date","Actions"]
        .forEach(t=>{const th=document.createElement("th");th.textContent=t;head.appendChild(th);});

      rows.forEach(j=>{
        const r = tbl.insertRow();
        r.insertCell().textContent = j.company;
        r.insertCell().innerHTML  = `<a href="${j.source_url}" target="_blank">${j.job_title}</a>`;
        r.insertCell().textContent = j.deadline        ?? '';
        r.insertCell().textContent = j.interview_date  ?? '';
        r.insertCell().textContent = j.status          ?? '';
        r.insertCell().textContent = j.apply_date      ?? '';
        r.insertCell().innerHTML =
          `<button onclick="openEdit(${j.id})">Edit</button>`;
      });

      box.replaceChildren(tbl);
    }

    /* ---------- æ‰“å¼€ç¼–è¾‘çª— ---------- */
    window.openEdit = function(id){
      window.open(
        `edit.html?id=${id}`,
        "editJob",
        "width=600,height=450"
      );
    };

    /* ---------- ç„¦ç‚¹å›åˆ°ä¸»çª—æ—¶ï¼Œè‹¥æ£€æµ‹åˆ° storage æ ‡è®°åˆ™åˆ·æ–° ---------- */
    function maybeReloadAfterEdit(){
      if(localStorage.getItem("jobUpdated")){
        localStorage.removeItem("jobUpdated");
        loadJobs();
      }
    }

    /* ---------- æœç´¢æ¡† ---------- */
    window.addEventListener("input", e=>{
      if(e.target.id==="search-box") renderTable(cache,null,e.target.value);
    });
  </script>
</head>

<body>
  <h1>Job Tracker</h1>

  <label>
    ğŸ” Search:
    <input id="search-box" placeholder="Title / Company / Vacancy Code">
  </label>

  <div id="job-table">Loadingâ€¦</div>

  <div id="form-container">
    <button
      hx-get="form.html"
      hx-target="#form-container"
      hx-swap="innerHTML">
      ï¼‹ AddÂ NewÂ Job
    </button>
  </div>
</body>
</html>
