<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Job Tracker</title>

  <!-- å…¨å±€æ ·å¼ -->
  <link rel="stylesheet" href="style.css">

  <!-- HTMXï¼ˆæ‡’åŠ è½½ edit.html / form.htmlï¼‰ -->
  <script src="https://unpkg.com/htmx.org@1.9.2"></script>

  <!-- Supabase SDK + ä¸»é€»è¾‘ -->
  <script type="module" defer>
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    /* ---------- Supabase åˆå§‹åŒ– ---------- */
    const supabase = createClient(
      "https://noyxgznbnarahetfecxj.supabase.co",
      "sb_publishable_uykLhOlTN6dhDiTr2SmdJQ_TV-XOhR9"
    );

    /* ---------- å…¬å…±å˜é‡ ---------- */
    let cache = [];  // ç¼“å­˜æœ€æ–°æ‹‰å–çš„æ•°æ®

    /* ---------- é¦–æ¬¡åŠ è½½ ---------- */
    document.addEventListener("DOMContentLoaded", loadJobs);

    /* ---------- äº‹ä»¶ï¼šæ–°å¢æˆ–ç¼–è¾‘ååˆ·æ–° ---------- */
    window.addEventListener("jobAdded",    loadJobs);
    window.addEventListener("jobUpdated",  loadJobs);

    /* ---------- æœç´¢æ¡†å®æ—¶è¿‡æ»¤ ---------- */
    document.addEventListener("input", e=>{
      if(e.target.id === "search-box"){
        renderTable(cache, null, e.target.value);
      }
    });

    /* ---------- æ‹‰å– & æ¸²æŸ“ ---------- */
    async function loadJobs(){
      const { data, error } = await supabase
        .from("view_upcoming_or_interviewing")  // åªè¯»è§†å›¾
        .select("*");
      renderTable(data, error);
    }

    function renderTable(data=[], error=null, keyword=''){
      cache = data || [];
      const container = document.getElementById("job-table");

      if(error){ container.textContent = "Error: " + error.message; return; }
      if(!Array.isArray(data) || !data.length){ container.textContent = "No data."; return; }

      /* å…³é”®è¯è¿‡æ»¤ */
      const q = keyword.trim().toLowerCase();
      const rows = q
        ? data.filter(j =>
            (j.job_title||'').toLowerCase().includes(q) ||
            (j.company||'').toLowerCase().includes(q)   ||
            (j.vacancy_code||'').toLowerCase().includes(q)
          )
        : data;

      /* ç”Ÿæˆè¡¨æ ¼ */
      const tbl = document.createElement("table");
      const head = tbl.insertRow();
      ["Company","Job Title","Deadline",
       "Interview","Status","Actions"]
        .forEach(t=>{
          const th = document.createElement("th");
          th.textContent = t;
          head.appendChild(th);
        });

      rows.forEach(j=>{
        const r = tbl.insertRow();
        r.insertCell().textContent = j.company;
        r.insertCell().innerHTML  = `<a href="${j.source_url}" target="_blank">${j.job_title}</a>`;
        r.insertCell().textContent = j.deadline       ?? '';
        r.insertCell().textContent = j.interview_date ?? '';
        r.insertCell().textContent = j.status         ?? '';
        r.insertCell().innerHTML =
          `<button
              hx-get="edit.html?id=${j.id}"
              hx-target="#form-container"
              hx-swap="innerHTML"
            >Edit</button>`;
      });

      container.replaceChildren(tbl);
    }
  </script>
</head>

<body>
  <h1>Job Tracker</h1>

  <!-- æœç´¢ -->
  <label>
    ğŸ” Search:
    <input id="search-box" placeholder="Title / Company / Vacancy Code">
  </label>

  <!-- è¡¨æ ¼å ä½ -->
  <div id="job-table">Loadingâ€¦</div>

  <!-- æ–°å¢æŒ‰é’® / è¡¨å• / ç¼–è¾‘å¼¹å±‚éƒ½ä¼šè£…è¿›è¿™é‡Œ -->
  <div id="form-container">
    <button
      id="show-form-btn"
      hx-get="form.html"
      hx-target="#form-container"
      hx-swap="innerHTML">
      ï¼‹ AddÂ NewÂ Job
    </button>
  </div>
</body>
</html>
